from fastapi import FastAPI, Depends, HTTPException
from typing import List
# استيراد مكتبة للمنطق الضبابي (يجب تثبيتها: pip install rapidfuzz)
from rapidfuzz import fuzz

app = FastAPI()

# محاكاة قاعدة بيانات الموظفين
DB_EMPLOYEES = {
    "emp_001": {"name": "أحمد", "level": "A"},
    "emp_002": {"name": "سارة", "level": "C"},
}

def get_employee_level(employee_id: str):
    emp = DB_EMPLOYEES.get(employee_id)
    if not emp:
        raise HTTPException(status_code=404, detail="الموظف غير موجود")
    return emp["level"]

def verify_access(employee_level: str, required_level: str):
    levels = {'A': 3, 'B': 2, 'C': 1}
    if levels.get(employee_level, 0) < levels.get(required_level, 0):
        raise HTTPException(status_code=403, detail="صلاحيات غير كافية")

@app.get("/search/")
async def search_intelligence_brain(query: str, employee_id: str):
    # 1. جلب رتبة الموظف الحقيقية
    current_level = get_employee_level(employee_id)
    
    # 2. تطبيق المنطق الضبابي لتحليل القصد (Intent Analysis)
    # لنفترض أن كلمة "عقد" أو "اتفاقية" تتطلب رتبة B
    sensitive_terms = ["عقد", "تمويل", "شركة x", "اتفاقية"]
    is_sensitive = False
    
    for term in sensitive_terms:
        # إذا كانت نسبة التشابه أكثر من 80% (منطق ضبابي)
        if fuzz.partial_ratio(query, term) > 80:
            is_sensitive = True
            break

    # 3. اتخاذ القرار بناءً على تحليل الحساسية
    if is_sensitive:
        verify_access(current_level, "B")
        return {
            "status": "success",
            "data": "تم إمضاء العقد في شهر 1 من عام 2022، طبيعته: تمويل",
            "voice_summary": "مرحباً، تم العثور على عقد التمويل لعام 2022."
        }
    
    return {"status": "success", "data": "نتائج بحث عامة لا تتطلب صلاحيات عادلة"}
